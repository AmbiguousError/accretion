<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accretion Disk and Planetary Formation Simulator</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            background-color: #212529; /* Bootstrap bg-dark */
        }
        canvas { 
            display: block; 
            background-color: #000; 
        }
        
        /* Gemini modal styles */
        #reportModal .modal-content {
             background-color: #343a40; /* Bootstrap dark gray */
        }
        #gemini-button {
            background: linear-gradient(90deg, #89f7fe 0%, #66a6ff 100%);
            color: #000;
            font-weight: bold;
        }
        /* Landing Overlay Styles */
        #landing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #landing-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        #settings-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 50;
        }
    </style>
</head>
<body class="text-light">

    <canvas id="simulationCanvas"></canvas>
    
    <!-- Landing Overlay -->
    <div id="landing-overlay">
        <div class="container-fluid text-center text-light" style="max-width: 800px;">
            <div class="p-5 bg-dark rounded-3 shadow-lg">
                <h1 class="display-5 fw-bold">Planetary Formation Simulator</h1>
                <p class="fs-4">Welcome! This is an interactive physics sandbox where you can create and observe the formation of planetary systems.</p>
                <hr class="my-4">
                <div class="text-start">
                    <p><strong>How it Works:</strong></p>
                    <ul>
                        <li>Use the controls in the <strong>Settings</strong> menu to define the physical properties of your new star system.</li>
                        <li>The simulation models gravity, particle collisions, and gas drag to show how a disk of dust and gas can evolve into planets.</li>
                        <li>Enable <strong>N-Body Physics</strong> to make every particle attract every other particle, allowing for realistic clumping and moon formation.</li>
                        <li>Create chaotic <strong>Binary</strong> or <strong>Trinary</strong> star systems and see how they affect planet development.</li>
                        <li>Click "Generate System Report âœ¨" to get a unique, AI-generated description of your creation from the Gemini API.</li>
                    </ul>
                </div>
                <button class="btn btn-primary btn-lg mt-4" id="start-simulation-button">Start Simulation</button>
            </div>
        </div>
    </div>

    <!-- Settings Button -->
    <button class="btn btn-dark" id="settings-button" type="button" data-bs-toggle="offcanvas" data-bs-target="#controlPanelOffcanvas" aria-controls="controlPanelOffcanvas">
        Settings
    </button>

    <!-- Offcanvas Control Panel -->
    <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="controlPanelOffcanvas" aria-labelledby="controlPanelOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="controlPanelOffcanvasLabel">Simulation Controls</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="mb-3"><label for="simSpeed" class="form-label">Simulation Speed</label><input type="range" class="form-range" id="simSpeed" min="0.05" max="5" value="0.3" step="0.05"></div>
            <div class="form-check mb-3"><input type="checkbox" class="form-check-input" id="nBodyToggle" checked><label for="nBodyToggle" class="form-check-label">Enable N-Body Physics</label></div>
            <div class="mb-3"><label for="theta" class="form-label">Sim Quality (Theta)</label><input type="range" class="form-range" id="theta" min="0" max="2" value="1.0" step="0.1"></div>
            
            <hr class="my-4"/>
            <h2 class="h5">Primary Star</h2>
            <div class="mb-3"><label for="starMass" class="form-label">Star Mass</label><input type="range" class="form-range" id="starMass" min="0.5" max="5" value="1.0" step="0.1"></div>
            
            <hr class="my-4"/>
            <h2 class="h5">Binary Companion</h2>
             <div class="form-check mb-3"><input type="checkbox" class="form-check-input" id="binaryToggle"><label for="binaryToggle" class="form-check-label">Enable Binary Star</label></div>
             <div id="binary-controls" class="d-none">
                <div class="mb-3"><label for="star2Mass" class="form-label">Companion Mass</label><input type="range" class="form-range" id="star2Mass" min="0.2" max="5" value="0.5" step="0.1"></div>
                <div class="mb-3"><label for="star2Dist" class="form-label">Companion Distance</label><input type="range" class="form-range" id="star2Dist" min="150" max="400" value="250" step="10"></div>
                <div class="mb-3"><label for="star2Speed" class="form-label">Companion Speed %</label><input type="range" class="form-range" id="star2Speed" min="0.5" max="1.5" value="1.0" step="0.05"></div>
             </div>

            <hr class="my-4"/>
            <h2 class="h5">Trinary Companion</h2>
             <div class="form-check mb-3"><input type="checkbox" class="form-check-input" id="trinaryToggle"><label for="trinaryToggle" class="form-check-label">Enable Trinary Star</label></div>
             <div id="trinary-controls" class="d-none">
                <div class="mb-3"><label for="star3Mass" class="form-label">Companion Mass</label><input type="range" class="form-range" id="star3Mass" min="0.2" max="5" value="0.3" step="0.1"></div>
                <div class="mb-3"><label for="star3Dist" class="form-label">Companion Distance</label><input type="range" class="form-range" id="star3Dist" min="50" max="200" value="100" step="5"></div>
                <div class="mb-3"><label for="star3Speed" class="form-label">Companion Speed %</label><input type="range" class="form-range" id="star3Speed" min="0.5" max="1.5" value="1.0" step="0.05"></div>
             </div>

            <hr class="my-4"/>
            <h2 class="h5">Protoplanetary Disk</h2>
            <div class="mb-3"><label for="diskDensity" class="form-label">Disk Density</label><input type="range" class="form-range" id="diskDensity" min="100" max="5000" value="2000" step="50"></div>
            <div class="mb-3"><label for="dustSize" class="form-label">Initial Dust Size</label><input type="range" class="form-range" id="dustSize" min="0.5" max="3" value="0.5" step="0.1"></div>
            <div class="mb-3"><label for="gravityConstant" class="form-label">Gravitational Constant</label><input type="range" class="form-range" id="gravityConstant" min="0.1" max="10" value="1.0" step="0.1"></div>
            <div class="mb-3"><label for="orbitalVelocity" class="form-label">Orbital Velocity %</label><input type="range" class="form-range" id="orbitalVelocity" min="0.8" max="1.2" value="1.0" step="0.01"></div>
            <div class="mb-3"><label for="cometCount" class="form-label">Number of Comets</label><input type="range" class="form-range" id="cometCount" min="0" max="50" value="50" step="1"></div>
            <div class="mb-3"><label for="gasDrag" class="form-label">Gas Drag</label><input type="range" class="form-range" id="gasDrag" min="0" max="0.001" value="0.00050" step="0.00005"></div>
            
            <div class="d-grid gap-2 d-md-flex">
                <button id="resetButton" class="btn btn-primary w-100">Reset Custom</button>
                <button id="solSystemButton" class="btn btn-warning w-100">Load Solar System</button>
            </div>

            <div class="info-box mt-3 p-2 rounded bg-secondary bg-opacity-25">
                <p class="mb-1"><strong>Time Elapsed:</strong> <span id="timeElapsed">0</span> years</p>
                <p class="mb-1"><strong>Largest Body Mass:</strong> <span id="largestBodyMass">0</span></p>
                <p class="mb-0"><strong>Particle Count:</strong> <span id="particleCount">0</span></p>
                <button id="gemini-button" class="btn w-100 mt-2">Generate System Report âœ¨</button>
            </div>
        </div>
    </div>

    <!-- Gemini Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">ðŸ”­ Astronomical Report</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="reportContent">
                    <p>Generating report from the deep field survey...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {

            const getEl = id => document.getElementById(id);
            const elements = { 
                canvas: getEl('simulationCanvas'), 
                ctx: getEl('simulationCanvas').getContext('2d'), 
                landingOverlay: getEl('landing-overlay'), 
                startButton: getEl('start-simulation-button'), 
                settingsButton: getEl('settings-button'), 
                simSpeedSlider: getEl('simSpeed'), 
                nBodyToggle: getEl('nBodyToggle'), 
                thetaSlider: getEl('theta'), 
                starMassSlider: getEl('starMass'), 
                diskDensitySlider: getEl('diskDensity'), 
                dustSizeSlider: getEl('dustSize'), 
                gravitySlider: getEl('gravityConstant'), 
                orbitalVelocitySlider: getEl('orbitalVelocity'), 
                cometCountSlider: getEl('cometCount'), 
                gasDragSlider: getEl('gasDrag'), 
                resetButton: getEl('resetButton'), 
                solSystemButton: getEl('solSystemButton'), 
                timeElapsedEl: getEl('timeElapsed'), 
                largestBodyMassEl: getEl('largestBodyMass'), 
                particleCountEl: getEl('particleCount'), 
                geminiButton: getEl('gemini-button'), 
                binaryToggle: getEl('binaryToggle'), 
                binaryControls: getEl('binary-controls'), 
                star2MassSlider: getEl('star2Mass'), 
                star2DistSlider: getEl('star2Dist'), 
                star2SpeedSlider: getEl('star2Speed'), 
                trinaryToggle: getEl('trinaryToggle'), 
                trinaryControls: getEl('trinary-controls'), 
                star3MassSlider: getEl('star3Mass'), 
                star3DistSlider: getEl('star3Dist'), 
                star3SpeedSlider: getEl('star3Speed')
            };

            class Boundary { constructor(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h;} contains(p){return p.x>=this.x&&p.x<this.x+this.w&&p.y>=this.y&&p.y<this.y+this.h;} }
            class QuadTree { constructor(b,c){this.boundary=b;this.capacity=c;this.particles=[];this.divided=!1;this.mass=0;this.cm_x=0;this.cm_y=0;} subdivide(){let{x,y,w,h}=this.boundary;this.northwest=new QuadTree(new Boundary(x,y,w/2,h/2),this.capacity);this.northeast=new QuadTree(new Boundary(x+w/2,y,w/2,h/2),this.capacity);this.southwest=new QuadTree(new Boundary(x,y+h/2,w/2,h/2),this.capacity);this.southeast=new QuadTree(new Boundary(x+w/2,y+h/2,w/2,h/2),this.capacity);this.divided=!0;} insert(p){if(!this.boundary.contains(p))return!1;if(this.particles.length<this.capacity)return this.particles.push(p),!0;this.divided||this.subdivide();return this.northeast.insert(p)||this.northwest.insert(p)||this.southeast.insert(p)||this.southwest.insert(p)} updateMass(){if(this.divided){this.northwest.updateMass();this.northeast.updateMass();this.southwest.updateMass();this.southeast.updateMass();this.mass=this.northwest.mass+this.northeast.mass+this.southwest.mass+this.southeast.mass;if(this.mass>0){this.cm_x=(this.northwest.cm_x*this.northwest.mass+this.northeast.cm_x*this.northeast.mass+this.southwest.cm_x*this.southwest.mass+this.southeast.cm_x*this.southeast.mass)/this.mass;this.cm_y=(this.northwest.cm_y*this.northwest.mass+this.northeast.cm_y*this.northeast.mass+this.southwest.cm_y*this.southwest.mass+this.southeast.cm_y*this.southeast.mass)/this.mass;}}else{this.mass=this.particles.reduce((s,p)=>s+p.mass,0);if(this.mass>0){this.cm_x=this.particles.reduce((s,p)=>s+p.x*p.mass,0)/this.mass;this.cm_y=this.particles.reduce((s,p)=>s+p.y*p.mass,0)/this.mass;}}} calculateForce(p,theta){if(this.mass===0)return;const dx=this.cm_x-p.x,dy=this.cm_y-p.y,distSq=dx*dx+dy*dy;if(distSq===0)return;const dist=Math.sqrt(distSq);if(this.divided){if(this.boundary.w/dist<theta){const force=N_BODY_G*this.mass/(distSq+SOFTENING_FACTOR_SQ);p.ax+=force*dx/dist;p.ay+=force*dy/dist;}else{this.northwest.calculateForce(p,theta);this.northeast.calculateForce(p,theta);this.southwest.calculateForce(p,theta);this.southeast.calculateForce(p,theta);}}else{for(const other of this.particles){if(p!==other){const dx_p=other.x-p.x,dy_p=other.y-p.y,distSq_p=dx_p*dx_p+dy_p*dy_p;if(distSq_p>0){const dist_p=Math.sqrt(distSq_p),force=N_BODY_G*other.mass/(distSq_p+SOFTENING_FACTOR_SQ);p.ax+=force*dx_p/dist_p;p.ay+=force*dy_p/dist_p;}}}}} }
            class Star { 
                constructor(x,y,m,r, color='#ffcc00'){this.x=x;this.y=y;this.vx=0; this.vy=0; this.ax=0; this.ay=0; this.mass=m;this.radius=r;this.color=color;} 
                resetForce() { this.ax = 0; this.ay = 0; }
                update(){this.vx+=this.ax;this.vy+=this.ay;this.x+=this.vx;this.y+=this.vy;} 
                draw(){const c=elements.ctx;c.save();c.beginPath();const grad_color = this.color === '#ffcc00' ? '#ffffc8' : this.color === '#aaccff' ? '#d4e8ff' : '#ffd4d4'; const g=c.createRadialGradient(this.x,this.y,this.radius*.2,this.x,this.y,this.radius);g.addColorStop(0,grad_color);g.addColorStop(.5,this.color);g.addColorStop(1,this.color+'00');c.fillStyle=g;c.shadowColor=this.color+'80';c.shadowBlur=50;c.arc(this.x,this.y,this.radius,0,Math.PI*2);c.fill();c.restore();} 
            }
            class Particle { 
                constructor(x,y,r,c,i=!1){this.x=x;this.y=y;this.vx=0;this.vy=0;this.ax=0;this.ay=0;this.radius=r;this.mass=Math.PI*r*r;this.color=c;this.isComet=i;this.collided=!1;} 
                resetForce(){this.ax=0;this.ay=0;} 
                draw(){const c=elements.ctx;c.save();c.beginPath();c.fillStyle=this.color;c.shadowColor=this.isComet?'#b4dfff':'#ffffffb3';c.shadowBlur=this.radius*1.5+2;c.arc(this.x,this.y,this.radius,0,Math.PI*2);c.fill();c.restore();} 
                applyGravityFrom(body){const dx=body.x-this.x,dy=body.y-this.y,distSq=dx*dx+dy*dy;if(distSq===0)return;const dist=Math.sqrt(distSq);if(dist<body.radius){this.collided=!0;return;}const acc=G*body.mass/distSq;this.ax+=acc*dx/dist;this.ay+=acc*dy/dist;} 
                update(){this.vx+=this.ax;this.vy+=this.ay;this.vx*=1-GAS_DRAG_FACTOR;this.vy*=1-GAS_DRAG_FACTOR;this.x+=this.vx;this.y+=this.vy;} 
            }
            
            let particles = [], stars = [], qt, animationFrameId, simulationTime = 0, STAR_MASS, NUM_PARTICLES, INITIAL_DUST_SIZE, G, ORBITAL_VELOCITY_FACTOR, NUM_COMETS, GAS_DRAG_FACTOR, N_BODY_ENABLED, THETA, N_BODY_G, SIMULATION_SPEED, BINARY_ENABLED, STAR2_MASS, STAR2_DIST, STAR2_SPEED, TRINARY_ENABLED, STAR3_MASS, STAR3_DIST, STAR3_SPEED;
            let timeAccumulator = 0;
            const SOFTENING_FACTOR = 20, SOFTENING_FACTOR_SQ = SOFTENING_FACTOR * SOFTENING_FACTOR, solarSystemData = [{ name: 'Mercury', au: .39, radius: 2, color: '#9f9f9f' }, { name: 'Venus', au: .72, radius: 3.5, color: '#d4c9a8' }, { name: 'Earth', au: 1, radius: 3.6, color: '#6b93d6' }, { name: 'Mars', au: 1.52, radius: 2.5, color: '#c1440e' }, { name: 'Jupiter', au: 5.2, radius: 9, color: '#d8ca9d' }, { name: 'Saturn', au: 9.58, radius: 8, color: '#f0e3a3' }, { name: 'Uranus', au: 19.22, radius: 6, color: '#aadae1' }, { name: 'Neptune', au: 30.05, radius: 5.8, color: '#5b5ddf' }];
            let reportModalInstance = null;
            
            async function generateReport() { if (!reportModalInstance) { reportModalInstance = new bootstrap.Modal(document.getElementById('reportModal')); } const reportContent = document.getElementById('reportContent'); reportContent.innerHTML = `<div class="d-flex justify-content-center align-items-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="ms-3 mb-0">Generating report...</p></div>`; reportModalInstance.show(); const significantPlanetCount = particles.filter(p => p.mass > 50).length; const largestMass = parseFloat(elements.largestBodyMassEl.textContent); let systemType = 'Single Star System'; if (BINARY_ENABLED) systemType = 'Binary Star System'; if (TRINARY_ENABLED && BINARY_ENABLED) systemType = 'Trinary Star System'; const prompt = `You are an astronomer writing a creative, one-paragraph observational report for a public outreach blog. Based on the following data, describe the state of this young, simulated planetary system. Be descriptive and imaginative.

**System Data:**
- **System Type:** ${systemType}.
- **System Age:** Approximately ${Math.floor(simulationTime).toLocaleString()} million years.
- **Primary Star Mass:** ${STAR_MASS.toFixed(1)} Solar Masses.
${BINARY_ENABLED ? `- **Companion Star Mass:** ${STAR2_MASS.toFixed(1)} Solar Masses.` : ''}
${TRINARY_ENABLED && BINARY_ENABLED ? `- **Third Star Mass:** ${STAR3_MASS.toFixed(1)} Solar Masses.` : ''}
- **Number of Major Planetesimals:** ${significantPlanetCount}.
- **Mass of Largest Body:** ${largestMass.toFixed(2)} relative mass units.
- **Remaining Debris Particles:** ${particles.length}.
- **Comet Population:** ${NUM_COMETS} active comets detected.
- **System Stability:** Orbital velocity factor is ${ORBITAL_VELOCITY_FACTOR * 100}%.

Write a captivating summary.`; try { let chatHistory = [{ role: "user", parts: [{ text: prompt }] }]; const payload = { contents: chatHistory }; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { throw new Error(`API request failed with status ${response.status}`); } const result = await response.json(); if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) { const text = result.candidates[0].content.parts[0].text; reportContent.innerHTML = text.replace(/\n/g, '<br>'); } else { throw new Error("Invalid response structure from API."); } } catch (error) { console.error("Gemini API Error:", error); reportContent.innerHTML = `<p class="text-danger">Error generating report. Could not connect to the observatory's deep space network. Please check the console for details.</p>`; } }
            function loadSolSystem() { if (animationFrameId) cancelAnimationFrame(animationFrameId); resizeCanvas(); elements.binaryToggle.checked = !1; elements.trinaryToggle.checked = !1; elements.nBodyToggle.checked = !1; elements.starMassSlider.value = 1; elements.gravitySlider.value = 2; elements.simSpeedSlider.value = 1; readAndSetParams(); const cX = elements.canvas.width / 2, cY = elements.canvas.height / 2; const primaryStar = new Star(cX, cY, STAR_MASS * 1e4, 15); stars = [primaryStar]; particles = []; const maxScreenDist = Math.min(cX, cY) * .9, neptuneAU = 30.05; solarSystemData.forEach(p => { const a = Math.random() * Math.PI * 2, dist = maxScreenDist * Math.pow(p.au / neptuneAU, .65), x = cX + Math.cos(a) * dist, y = cY + Math.sin(a) * dist, planet = new Particle(x, y, p.radius, p.color), oV = Math.sqrt(G * primaryStar.mass / dist); planet.vx = -Math.sin(a) * oV; planet.vy = Math.cos(a) * oV; particles.push(planet); }); animate(); }
            function init() { if (animationFrameId) cancelAnimationFrame(animationFrameId); resizeCanvas(); readAndSetParams(); const cX = elements.canvas.width / 2, cY = elements.canvas.height / 2; const primaryStar = new Star(0, 0, STAR_MASS * 1e4, 15 + (STAR_MASS - 1) * 5); stars = [primaryStar]; if (BINARY_ENABLED) { const star2 = new Star(0, 0, STAR2_MASS * 1e4, 10 + (STAR2_MASS - 1) * 4, '#aaccff'); const m1 = primaryStar.mass, m2 = star2.mass; const dist = STAR2_DIST; const speed = Math.sqrt(G * (m1 + m2) / dist) * STAR2_SPEED; star2.x = dist * (m1 / (m1 + m2)); primaryStar.x = -dist * (m2 / (m1 + m2)); star2.vy = -speed * (m1 / (m1 + m2)); primaryStar.vy = speed * (m2 / (m1 + m2)); stars.push(star2); } if (TRINARY_ENABLED && BINARY_ENABLED) { const star3 = new Star(0, 0, STAR3_MASS * 1e4, 8 + (STAR3_MASS - 1) * 4, '#ffaaaa'); const m12 = stars[0].mass + stars[1].mass; const m3 = star3.mass; const com12_x = (stars[0].x * stars[0].mass + stars[1].x * stars[1].mass) / m12; const com12_y = (stars[0].y * stars[0].mass + stars[1].y * stars[1].mass) / m12; const com12_vy = (stars[0].vy * stars[0].mass + stars[1].vy * stars[1].mass) / m12; const dist = STAR3_DIST; const speed = Math.sqrt(G * (m12 + m3) / dist) * STAR3_SPEED; star3.x = com12_x + dist * (m12 / (m12 + m3)); stars[0].x -= dist * (m3 / (m12 + m3)); stars[1].x -= dist * (m3 / (m12 + m3)); star3.vy = com12_vy - speed * (m12 / (m12 + m3)); stars[0].vy += speed * (m3 / (m12 + m3)); stars[1].vy += speed * (m3 / (m12 + m3)); stars.push(star3); } const totalMass = stars.reduce((sum, s) => sum + s.mass, 0); const com_x = stars.reduce((sum, s) => sum + s.x * s.mass, 0) / totalMass; const com_y = stars.reduce((sum, s) => sum + s.y * s.mass, 0) / totalMass; const com_vx = stars.reduce((sum, s) => sum + s.vx * s.mass, 0) / totalMass; const com_vy = stars.reduce((sum, s) => sum + s.vy * s.mass, 0) / totalMass; stars.forEach(s => { s.x += (cX - com_x); s.y += (cY - com_y); s.vx -= com_vx; s.vy -= com_vy; }); particles = []; const maxDist = Math.min(cX, cY) * .9, minDist = stars.reduce((m, s) => Math.max(m, s.radius), 0) * 5; for (let i = 0; i < NUM_PARTICLES; i++) { const a = Math.random() * Math.PI * 2, d = Math.sqrt(Math.random()) * (maxDist - minDist) + minDist, x = cX + Math.cos(a) * d, y = cY + Math.sin(a) * d, r = (Math.random() * .5 + .5) * INITIAL_DUST_SIZE, p = new Particle(x, y, r, 'white'); const oV = Math.sqrt(G * totalMass / d); p.vx = -Math.sin(a) * oV * ORBITAL_VELOCITY_FACTOR - com_vx; p.vy = Math.cos(a) * oV * ORBITAL_VELOCITY_FACTOR - com_vy; particles.push(p); } for (let i = 0; i < NUM_COMETS; i++) { const a = Math.random() * Math.PI * 2, d = (Math.random() * .2 + .8) * maxDist, x = cX + Math.cos(a) * d, y = cY + Math.sin(a) * d, r = (Math.random() * .5 + 1) * INITIAL_DUST_SIZE, p = new Particle(x, y, r, '#cceeff', !0); const oV = Math.sqrt(G * totalMass / d), cV = 1.4; p.vx = -Math.sin(a) * oV * cV - com_vx; p.vy = Math.cos(a) * oV * cV - com_vy; particles.push(p); } animate(); }
            function readAndSetParams() { SIMULATION_SPEED = parseFloat(elements.simSpeedSlider.value); N_BODY_ENABLED = elements.nBodyToggle.checked; THETA = parseFloat(elements.thetaSlider.value); STAR_MASS = parseFloat(elements.starMassSlider.value); NUM_PARTICLES = parseInt(elements.diskDensitySlider.value); INITIAL_DUST_SIZE = parseFloat(elements.dustSizeSlider.value); G = parseFloat(elements.gravitySlider.value); N_BODY_G = G * .05; ORBITAL_VELOCITY_FACTOR = parseFloat(elements.orbitalVelocitySlider.value); NUM_COMETS = parseInt(elements.cometCountSlider.value); GAS_DRAG_FACTOR = parseFloat(elements.gasDragSlider.value); BINARY_ENABLED = elements.binaryToggle.checked; elements.binaryControls.classList.toggle('d-none', !BINARY_ENABLED); STAR2_MASS = parseFloat(elements.star2MassSlider.value); STAR2_DIST = parseFloat(elements.star2DistSlider.value); STAR2_SPEED = parseFloat(elements.star2SpeedSlider.value); TRINARY_ENABLED = elements.trinaryToggle.checked; elements.trinaryControls.classList.toggle('d-none', !TRINARY_ENABLED || !BINARY_ENABLED); STAR3_MASS = parseFloat(elements.star3MassSlider.value); STAR3_DIST = parseFloat(elements.star3DistSlider.value); STAR3_SPEED = parseFloat(elements.star3SpeedSlider.value); timeAccumulator = 0; simulationTime = 0; updateLabels(); }
            function checkCollisions() { for (let i = 0; i < particles.length; i++) { if (particles[i].collided) continue; for (let j = i + 1; j < particles.length; j++) { if (particles[j].collided) continue; const dx = particles[j].x - particles[i].x, dy = particles[j].y - particles[i].y, dist = Math.sqrt(dx * dx + dy * dy); if (dist < particles[i].radius + particles[j].radius) { const tM = particles[i].mass + particles[j].mass, nV_x = (particles[i].vx * particles[i].mass + particles[j].vx * particles[j].mass) / tM, nV_y = (particles[i].vy * particles[i].mass + particles[j].vy * particles[j].mass) / tM, nX = (particles[i].x * particles[i].mass + particles[j].x * particles[j].mass) / tM, nY = (particles[i].y * particles[i].mass + particles[j].y * particles[j].mass) / tM, nR = Math.sqrt(Math.pow(particles[i].radius, 2) + Math.pow(particles[j].radius, 2)); particles[i].x = nX; particles[i].y = nY; particles[i].vx = nV_x; particles[i].vy = nV_y; particles[i].radius = nR; particles[i].mass = tM; particles[j].collided = !0; } } } particles = particles.filter(p => !p.collided); }
            function updateLabels() { const l = (e, t) => { const target = e.nextElementSibling || e.parentElement.querySelector('.form-check-label'); if (target) target.textContent = t; else e.parentElement.querySelector('label').textContent = t }; l(elements.simSpeedSlider, `Simulation Speed (${SIMULATION_SPEED.toFixed(2)}x)`); l(elements.thetaSlider, `Sim Quality (Theta: ${THETA.toFixed(1)})`); l(elements.starMassSlider, `Star Mass (${STAR_MASS.toFixed(1)})`); l(elements.diskDensitySlider, `Disk Density (${NUM_PARTICLES})`); l(elements.dustSizeSlider, `Initial Dust Size (${INITIAL_DUST_SIZE.toFixed(1)})`); l(elements.gravitySlider, `Gravitational Constant (${G.toFixed(1)})`); l(elements.orbitalVelocitySlider, `Orbital Velocity % (${(ORBITAL_VELOCITY_FACTOR * 100).toFixed(0)}%)`); l(elements.cometCountSlider, `Number of Comets (${NUM_COMETS})`); l(elements.gasDragSlider, `Gas Drag (${GAS_DRAG_FACTOR.toFixed(5)})`); l(elements.star2MassSlider, `Companion Mass (${STAR2_MASS.toFixed(1)})`); l(elements.star2DistSlider, `Companion Distance (${STAR2_DIST})`); l(elements.star2SpeedSlider, `Companion Speed % (${(STAR2_SPEED * 100).toFixed(0)}%)`); l(elements.star3MassSlider, `Companion Mass (${STAR3_MASS.toFixed(1)})`); l(elements.star3DistSlider, `Companion Distance (${STAR3_DIST})`); l(elements.star3SpeedSlider, `Companion Speed % (${(STAR3_SPEED*100).toFixed(0)}%)`); updateInfoPanel(); }
            function updateInfoPanel() { let m = particles.reduce((m, p) => p.mass > m ? p.mass : m, 0); elements.timeElapsedEl.textContent = Math.floor(simulationTime).toLocaleString(); elements.largestBodyMassEl.textContent = m.toFixed(2); elements.particleCountEl.textContent = particles.length.toLocaleString(); }
            function animate() { timeAccumulator += SIMULATION_SPEED; while (timeAccumulator >= 1) { stars.forEach(s => s.resetForce()); particles.forEach(p => p.resetForce()); if (stars.length > 1) { for (let i = 0; i < stars.length; i++) { for (let j = i + 1; j < stars.length; j++) { const s1 = stars[i], s2 = stars[j]; const dx = s2.x - s1.x, dy = s2.y - s1.y, distSq = dx * dx + dy * dy; if (distSq > 0) { const dist = Math.sqrt(distSq); const force = G * s1.mass * s2.mass / distSq; s1.ax += force * dx / dist / s1.mass; s1.ay += force * dy / dist / s1.mass; s2.ax -= force * dx / dist / s2.mass; s2.ay -= force * dy / dist / s2.mass; } } } } if (N_BODY_ENABLED) { const b = new Boundary(-elements.canvas.width * 2, -elements.canvas.height * 2, elements.canvas.width * 5, elements.canvas.height * 5); qt = new QuadTree(b, 4); particles.forEach(p => { qt.insert(p); }); qt.updateMass(); particles.forEach(p => { stars.forEach(s => p.applyGravityFrom(s)); qt.calculateForce(p, THETA); }); } else { particles.forEach(p => { stars.forEach(s => p.applyGravityFrom(s)); }); } particles.forEach(p => p.update()); stars.forEach(s => s.update()); checkCollisions(); simulationTime += 1; timeAccumulator -= 1; } elements.ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height); stars.forEach(s => s.draw()); particles.forEach(p => p.draw()); updateInfoPanel(); animationFrameId = requestAnimationFrame(animate); }
            function resizeCanvas() { elements.canvas.width = window.innerWidth; elements.canvas.height = window.innerHeight; }
            
            elements.startButton.addEventListener('click', () => {
                elements.landingOverlay.style.opacity = '0';
                setTimeout(() => {
                    elements.landingOverlay.style.display = 'none';
                    init();
                }, 500);
            });
            
            elements.landingOverlay.classList.add('visible');

            window.addEventListener('resize', init); 
            elements.resetButton.addEventListener('click', init); 
            elements.solSystemButton.addEventListener('click', loadSolSystem); 
            elements.minimizeButton.addEventListener('click', () => elements.controlPanel.classList.toggle('minimized'));
            elements.binaryToggle.addEventListener('change', init);
            elements.trinaryToggle.addEventListener('change', init);
            elements.geminiButton.addEventListener('click', generateReport);
            elements.nBodyToggle.addEventListener('change', init);
            [elements.simSpeedSlider, elements.thetaSlider, elements.starMassSlider, elements.diskDensitySlider, elements.dustSizeSlider, elements.gravitySlider, elements.orbitalVelocitySlider, elements.cometCountSlider, elements.gasDragSlider, elements.star2MassSlider, elements.star2DistSlider, elements.star2SpeedSlider, elements.star3MassSlider, elements.star3DistSlider, elements.star3SpeedSlider].forEach(s => { s.addEventListener('input', () => { readAndSetParams(); if (s.id !== 'simSpeed' && s.id !== 'theta') init(); }); });
        });
    </script>
</body>
</html>
